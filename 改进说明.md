# 错误处理改进说明

## 改进时间
2026-02-17

## 问题来源
从服务器日志发现的两个错误场景：

1. **空消息内容** → 上游返回 `Improperly formed request`
2. **Prefill 处理后消息为空** → 本地报错 `消息列表为空`
3. **错误分类错误** → `Improperly formed request` 被误报为"上下文过长"

## 实施的三个改进

### 1. 修复错误分类 (handlers.rs:44-54)

**问题**：`is_input_too_long_error` 错误地包含 `"Improperly formed request"`

**修复**：
```rust
// 移除前
s.contains("Improperly formed request")  // ❌

// 移除后 - 新增专门的检测函数
fn is_improperly_formed_request_error(err: &Error) -> bool {
    s.contains("Improperly formed request")
}
```

**新增错误映射** (handlers.rs:308-320)：
```rust
if is_improperly_formed_request_error(&err) {
    return BAD_REQUEST with "Improperly formed request. Check message content..."
}
```

### 2. 添加空消息内容验证 (converter.rs:289-310)

**新增错误类型**：
```rust
pub enum ConversionError {
    EmptyMessageContent,  // ✨ 新增
}
```

**验证逻辑**：在 prefill 处理后立即验证最后一条消息内容
- 支持字符串和数组两种 content 格式
- 检查文本内容是否为空或仅包含空白字符
- 图片、tool_use、tool_result 视为有效内容

### 3. 更新错误处理器 (handlers.rs:606, 1246)

在两处 match 语句中添加：
```rust
ConversionError::EmptyMessageContent => {
    ("invalid_request_error", "消息内容为空".to_string())
}
```

## 测试覆盖

新增 3 个测试用例：
- `test_convert_request_empty_message_content` - 空字符串
- `test_convert_request_empty_text_block` - 空白文本块
- `test_convert_request_prefill_with_empty_user_message` - Prefill 空消息

**测试结果**：✅ 286/286 通过

## 代码改动统计

```
 Cargo.lock                 |   2 +-
 src/anthropic/converter.rs | 121 +++++++++++++++++++++++++++++
 src/anthropic/handlers.rs  |  31 +++++++-
 3 files changed, 150 insertions(+), 4 deletions(-)
```

## 效果

1. **提前拦截无效请求** - 空消息在本地验证阶段被拦截，避免向上游发送
2. **准确的错误分类** - `Improperly formed request` 不再被误报为"上下文过长"
3. **改进 Prefill 处理** - 回退后验证消息有效性，提供清晰的错误信息

## 验证方法

```bash
# 运行测试
cargo test

# 使用测试脚本验证（需先启动服务）
python3 tools/test_empty_content.py
```
